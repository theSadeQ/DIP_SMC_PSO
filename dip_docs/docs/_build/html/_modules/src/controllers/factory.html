<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>src.controllers.factory &#8212; DIP_SMC_PSO Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8e8a900e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=fb9458d3" />
    <script src="../../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">DIP_SMC_PSO Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">src.controllers.factory</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for src.controllers.factory</h1><div class="highlight"><pre>
<span></span><span class="c1">#==========================================================================================\\\</span>
<span class="c1">#================================ src/controllers/factory.py ==============================\\\</span>
<span class="c1">#==========================================================================================\\\</span>

<span class="sd">&quot;&quot;&quot;Controller factory with Pydantic v2 config alignment and robust error handling.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Mapping</span>

<span class="c1"># Exported public API</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;build_controller&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_all&quot;</span><span class="p">,</span>
    <span class="s2">&quot;create_controller&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_canonical&quot;</span><span class="p">,</span>
    <span class="s2">&quot;normalize_controller_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;apply_deprecation_mapping&quot;</span><span class="p">,</span>
    <span class="s2">&quot;register_controller&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FactoryConfigurationError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ConfigValueError&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UnknownConfigKeyError&quot;</span>
<span class="p">]</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutableMapping</span>
<span class="c1"># --- module logger (module-level; safe even if logging configured elsewhere) ---</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;project.factory&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
    <span class="n">_h</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">_h</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">_h</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># ---------- custom exceptions ----------</span>
<div class="viewcode-block" id="FactoryConfigurationError">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.FactoryConfigurationError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FactoryConfigurationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when controller configuration or resolution fails.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ConfigValueError">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.ConfigValueError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConfigValueError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a config value is out of the accepted range.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="UnknownConfigKeyError">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.UnknownConfigKeyError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UnknownConfigKeyError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when unexpected/unknown keys appear in a controller config block.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="c1"># --- module logger (module-level; safe if configured elsewhere) ---</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;project.factory&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
    <span class="n">_h</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">_h</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">_h</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># ---------- Controller Registry ----------</span>
<span class="n">CONTROLLER_REGISTRY</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">CONTROLLER_REGISTRY_LOCK</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="c1"># ---------- Normalization Maps ----------</span>
<span class="c1"># Controller name aliases (normalized -&gt; canonical)</span>
<span class="n">ALIAS_MAP</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;smc_v1&quot;</span><span class="p">:</span> <span class="s2">&quot;classical_smc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;classic_smc&quot;</span><span class="p">:</span> <span class="s2">&quot;classical_smc&quot;</span><span class="p">,</span>  <span class="c1"># Allow both forms</span>
    <span class="s2">&quot;smc_classic&quot;</span><span class="p">:</span> <span class="s2">&quot;classical_smc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sta&quot;</span><span class="p">:</span> <span class="s2">&quot;sta_smc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;super_twisting&quot;</span><span class="p">:</span> <span class="s2">&quot;sta_smc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;adaptive&quot;</span><span class="p">:</span> <span class="s2">&quot;adaptive_smc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;swing_up&quot;</span><span class="p">:</span> <span class="s2">&quot;swing_up_smc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hybrid&quot;</span><span class="p">:</span> <span class="s2">&quot;hybrid_adaptive_sta_smc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hybrid_sta&quot;</span><span class="p">:</span> <span class="s2">&quot;hybrid_adaptive_sta_smc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mpc&quot;</span><span class="p">:</span> <span class="s2">&quot;mpc_controller&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Deprecated parameter mappings per controller</span>
<span class="n">DEPRECATED_PARAM_MAP</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;classical_smc&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;boundaryLayer&quot;</span><span class="p">:</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;boundary-layer&quot;</span><span class="p">:</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxForce&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max-force&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dampingGain&quot;</span><span class="p">:</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;damping-gain&quot;</span><span class="p">:</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switchMethod&quot;</span><span class="p">:</span> <span class="s2">&quot;switch_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switch-method&quot;</span><span class="p">:</span> <span class="s2">&quot;switch_method&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;sta_smc&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;boundaryLayer&quot;</span><span class="p">:</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;boundary-layer&quot;</span><span class="p">:</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxForce&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max-force&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dampingGain&quot;</span><span class="p">:</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;damping-gain&quot;</span><span class="p">:</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switchMethod&quot;</span><span class="p">:</span> <span class="s2">&quot;switch_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switch-method&quot;</span><span class="p">:</span> <span class="s2">&quot;switch_method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;antiWindupGain&quot;</span><span class="p">:</span> <span class="s2">&quot;anti_windup_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;anti-windup-gain&quot;</span><span class="p">:</span> <span class="s2">&quot;anti_windup_gain&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;adaptive_smc&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;maxForce&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max-force&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;leakRate&quot;</span><span class="p">:</span> <span class="s2">&quot;leak_rate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;leak-rate&quot;</span><span class="p">:</span> <span class="s2">&quot;leak_rate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;deadZone&quot;</span><span class="p">:</span> <span class="s2">&quot;dead_zone&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dead-zone&quot;</span><span class="p">:</span> <span class="s2">&quot;dead_zone&quot;</span><span class="p">,</span>
        <span class="s2">&quot;adaptRateLimit&quot;</span><span class="p">:</span> <span class="s2">&quot;adapt_rate_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;adapt-rate-limit&quot;</span><span class="p">:</span> <span class="s2">&quot;adapt_rate_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;smoothSwitch&quot;</span><span class="p">:</span> <span class="s2">&quot;smooth_switch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;smooth-switch&quot;</span><span class="p">:</span> <span class="s2">&quot;smooth_switch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;boundaryLayer&quot;</span><span class="p">:</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;boundary-layer&quot;</span><span class="p">:</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;k_min&quot;</span><span class="p">:</span> <span class="s2">&quot;K_min&quot;</span><span class="p">,</span>  <span class="c1"># normalized lowercase to uppercase</span>
        <span class="s2">&quot;k_max&quot;</span><span class="p">:</span> <span class="s2">&quot;K_max&quot;</span><span class="p">,</span>  <span class="c1"># normalized lowercase to uppercase</span>
        <span class="s2">&quot;k_init&quot;</span><span class="p">:</span> <span class="s2">&quot;K_init&quot;</span><span class="p">,</span>  <span class="c1"># normalized lowercase to uppercase</span>
    <span class="p">},</span>
    <span class="s2">&quot;hybrid_adaptive_sta_smc&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;use_equivalent&quot;</span><span class="p">:</span> <span class="s2">&quot;enable_equivalent&quot;</span><span class="p">,</span>  <span class="c1"># Special deprecated alias</span>
        <span class="s2">&quot;useEquivalent&quot;</span><span class="p">:</span> <span class="s2">&quot;enable_equivalent&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxForce&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max-force&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dampingGain&quot;</span><span class="p">:</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;damping-gain&quot;</span><span class="p">:</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;adaptRateLimit&quot;</span><span class="p">:</span> <span class="s2">&quot;adapt_rate_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;adapt-rate-limit&quot;</span><span class="p">:</span> <span class="s2">&quot;adapt_rate_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;satSoftWidth&quot;</span><span class="p">:</span> <span class="s2">&quot;sat_soft_width&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sat-soft-width&quot;</span><span class="p">:</span> <span class="s2">&quot;sat_soft_width&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cartGain&quot;</span><span class="p">:</span> <span class="s2">&quot;cart_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cart-gain&quot;</span><span class="p">:</span> <span class="s2">&quot;cart_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cartLambda&quot;</span><span class="p">:</span> <span class="s2">&quot;cart_lambda&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cart-lambda&quot;</span><span class="p">:</span> <span class="s2">&quot;cart_lambda&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;mpc_controller&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;maxForce&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max-force&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxCartPos&quot;</span><span class="p">:</span> <span class="s2">&quot;max_cart_pos&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max-cart-pos&quot;</span><span class="p">:</span> <span class="s2">&quot;max_cart_pos&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxThetaDev&quot;</span><span class="p">:</span> <span class="s2">&quot;max_theta_dev&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max-theta-dev&quot;</span><span class="p">:</span> <span class="s2">&quot;max_theta_dev&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallbackSmcGains&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback_smc_gains&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallback-smc-gains&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback_smc_gains&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallbackPdKp&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback_pd_kp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallback-pd-kp&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback_pd_kp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallbackPdKd&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback_pd_kd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallback-pd-kd&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback_pd_kd&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;swing_up_smc&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;stabilizingController&quot;</span><span class="p">:</span> <span class="s2">&quot;stabilizing_controller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stabilizing-controller&quot;</span><span class="p">:</span> <span class="s2">&quot;stabilizing_controller&quot;</span><span class="p">,</span>
        <span class="s2">&quot;energyGain&quot;</span><span class="p">:</span> <span class="s2">&quot;energy_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;energy-gain&quot;</span><span class="p">:</span> <span class="s2">&quot;energy_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switchEnergyFactor&quot;</span><span class="p">:</span> <span class="s2">&quot;switch_energy_factor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switch-energy-factor&quot;</span><span class="p">:</span> <span class="s2">&quot;switch_energy_factor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exitEnergyFactor&quot;</span><span class="p">:</span> <span class="s2">&quot;exit_energy_factor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exit-energy-factor&quot;</span><span class="p">:</span> <span class="s2">&quot;exit_energy_factor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switchAngleTolerance&quot;</span><span class="p">:</span> <span class="s2">&quot;switch_angle_tolerance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switch-angle-tolerance&quot;</span><span class="p">:</span> <span class="s2">&quot;switch_angle_tolerance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reentryAngleTolerance&quot;</span><span class="p">:</span> <span class="s2">&quot;reentry_angle_tolerance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reentry-angle-tolerance&quot;</span><span class="p">:</span> <span class="s2">&quot;reentry_angle_tolerance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxForce&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max-force&quot;</span><span class="p">:</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># ---------- DRY import helper ----------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_try_import</span><span class="p">(</span><span class="n">primary_mod</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fallback_mod</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try importing ``attr`` from ``primary_mod`` then ``fallback_mod``.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">primary_mod</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">fallback_mod</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not import </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2"> from either &#39;</span><span class="si">{</span><span class="n">primary_mod</span><span class="si">}</span><span class="s2">&#39; or &#39;</span><span class="si">{</span><span class="n">fallback_mod</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

<span class="c1"># ---- tolerant imports (controllers) ----</span>
<span class="n">ClassicalSMC</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;src.controllers.classic_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;controllers.classic_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;ClassicalSMC&quot;</span><span class="p">)</span>
<span class="n">SuperTwistingSMC</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;src.controllers.sta_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;controllers.sta_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;SuperTwistingSMC&quot;</span><span class="p">)</span>
<span class="n">AdaptiveSMC</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;src.controllers.adaptive_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;controllers.adaptive_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;AdaptiveSMC&quot;</span><span class="p">)</span>
<span class="n">SwingUpSMC</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;src.controllers.swing_up_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;controllers.swing_up_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;SwingUpSMC&quot;</span><span class="p">)</span>
<span class="n">MPCController</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;src.controllers.mpc_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;controllers.mpc_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;MPCController&quot;</span><span class="p">)</span>
<span class="n">MPCWeights</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;src.controllers.mpc_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;controllers.mpc_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;MPCWeights&quot;</span><span class="p">)</span>
<span class="n">HybridAdaptiveSTASMC</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span>
    <span class="s2">&quot;src.controllers.hybrid_adaptive_sta_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;controllers.hybrid_adaptive_sta_smc&quot;</span><span class="p">,</span> <span class="s2">&quot;HybridAdaptiveSTASMC&quot;</span>
<span class="p">)</span>

<span class="c1"># ---- tolerant imports (config) ----</span>
<span class="n">ConfigSchema</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;src.config&quot;</span><span class="p">,</span> <span class="s2">&quot;ConfigSchema&quot;</span><span class="p">)</span>
<span class="n">load_config</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;src.config&quot;</span><span class="p">,</span> <span class="s2">&quot;load_config&quot;</span><span class="p">)</span>
<span class="n">PhysicsConfig</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;src.config&quot;</span><span class="p">,</span> <span class="s2">&quot;PhysicsConfig&quot;</span><span class="p">)</span>

<span class="c1"># ---- tolerant imports (dynamics) ----</span>
<span class="n">DoubleInvertedPendulum</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;core.dynamics&quot;</span><span class="p">,</span> <span class="s2">&quot;src.core.dynamics&quot;</span><span class="p">,</span> <span class="s2">&quot;DoubleInvertedPendulum&quot;</span><span class="p">)</span>
<span class="n">FullDIPDynamics</span> <span class="o">=</span> <span class="n">_try_import</span><span class="p">(</span><span class="s2">&quot;core.dynamics_full&quot;</span><span class="p">,</span> <span class="s2">&quot;src.core.dynamics_full&quot;</span><span class="p">,</span> <span class="s2">&quot;FullDIPDynamics&quot;</span><span class="p">)</span>

<span class="c1"># ---- utilities ----</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.seed</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_global_seed</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_global_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fallback when seed utility is unavailable.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set global seed to </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ---------- Normalization Functions ----------</span>
<div class="viewcode-block" id="normalize_controller_name">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.normalize_controller_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_controller_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize controller name and apply aliases.</span>
<span class="sd">    </span>
<span class="sd">    Lowercase, trim, replace hyphens/spaces/dots with underscores,</span>
<span class="sd">    then check alias map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    
    <span class="c1"># Basic normalization</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">]:</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    
    <span class="c1"># Apply alias mapping</span>
    <span class="n">canonical</span> <span class="o">=</span> <span class="n">ALIAS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="n">normalized</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">normalized</span> <span class="o">!=</span> <span class="n">canonical</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controller name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; normalized to &#39;</span><span class="si">{</span><span class="n">canonical</span><span class="si">}</span><span class="s2">&#39; via alias&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">normalized</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controller name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; normalized to &#39;</span><span class="si">{</span><span class="n">normalized</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">canonical</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">normalize_param_key</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize parameter key: lowercase, replace hyphens/spaces with underscores.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># Special case: preserve capitalization for K_ parameters</span>
    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;K_&#39;</span><span class="p">):</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">]:</span>
            <span class="n">normalized</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normalized</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">]:</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">normalized</span>

<div class="viewcode-block" id="apply_deprecation_mapping">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.apply_deprecation_mapping">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_deprecation_mapping</span><span class="p">(</span>
    <span class="n">controller_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
    <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply deprecation mapping for a controller&#39;s parameters.</span>
<span class="sd">    </span>
<span class="sd">    Returns normalized params dict with deprecated keys mapped to current ones.</span>
<span class="sd">    Emits DeprecationWarning for each deprecated key found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deprecation_map</span> <span class="o">=</span> <span class="n">DEPRECATED_PARAM_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">controller_name</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">normalized_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">unknown_params</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Track which normalized keys we&#39;ve seen to detect collisions</span>
    <span class="n">seen_normalized</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">original_key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># First normalize the key</span>
        <span class="n">norm_key</span> <span class="o">=</span> <span class="n">normalize_param_key</span><span class="p">(</span><span class="n">original_key</span><span class="p">)</span>
        
        <span class="c1"># Check for deprecation (use original key for deprecation lookup)</span>
        <span class="k">if</span> <span class="n">original_key</span> <span class="ow">in</span> <span class="n">deprecation_map</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">deprecation_map</span><span class="p">[</span><span class="n">original_key</span><span class="p">]</span>
            <span class="c1"># Only apply deprecation if the new key isn&#39;t already set</span>
            <span class="k">if</span> <span class="n">new_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">new_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">normalized_params</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">original_key</span><span class="si">}</span><span class="s2">&#39; is deprecated for </span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please use &#39;</span><span class="si">{</span><span class="n">new_key</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped deprecated param &#39;</span><span class="si">{</span><span class="n">original_key</span><span class="si">}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{</span><span class="n">new_key</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">norm_key</span> <span class="o">=</span> <span class="n">new_key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># New key already set, skip the deprecated one</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping deprecated param &#39;</span><span class="si">{</span><span class="n">original_key</span><span class="si">}</span><span class="s2">&#39; as &#39;</span><span class="si">{</span><span class="n">new_key</span><span class="si">}</span><span class="s2">&#39; is already set&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="c1"># Also check normalized form in deprecation map</span>
        <span class="k">elif</span> <span class="n">norm_key</span> <span class="ow">in</span> <span class="n">deprecation_map</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">deprecation_map</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">new_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">normalized_params</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">original_key</span><span class="si">}</span><span class="s2">&#39; (normalized: &#39;</span><span class="si">{</span><span class="n">norm_key</span><span class="si">}</span><span class="s2">&#39;) is deprecated for </span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please use &#39;</span><span class="si">{</span><span class="n">new_key</span><span class="si">}</span><span class="s2">&#39; instead.&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped deprecated param &#39;</span><span class="si">{</span><span class="n">norm_key</span><span class="si">}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{</span><span class="n">new_key</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">norm_key</span> <span class="o">=</span> <span class="n">new_key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="c1"># Check for key collision after normalization</span>
        <span class="k">if</span> <span class="n">norm_key</span> <span class="ow">in</span> <span class="n">seen_normalized</span> <span class="ow">and</span> <span class="n">seen_normalized</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">original_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">: Parameter keys &#39;</span><span class="si">{</span><span class="n">seen_normalized</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;and &#39;</span><span class="si">{</span><span class="n">original_key</span><span class="si">}</span><span class="s2">&#39; both normalize to &#39;</span><span class="si">{</span><span class="n">norm_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
        
        <span class="n">seen_normalized</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_key</span>
        <span class="n">normalized_params</span><span class="p">[</span><span class="n">norm_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">return</span> <span class="n">normalized_params</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">redact_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Redact sensitive values for logging.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;None&quot;</span>
    <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">value_str</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;secret&quot;</span><span class="p">,</span> <span class="s2">&quot;token&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;api&quot;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="s2">&quot;***&quot;</span>
    <span class="c1"># Also redact if the key name suggests sensitivity</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># ---------- Registry Functions ----------</span>
<div class="viewcode-block" id="register_controller">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.register_controller">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">register_controller</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator for registering controller constructors.</span>
<span class="sd">    </span>
<span class="sd">    Registration is idempotent - re-registering the same name overwrites.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">normalized_name</span> <span class="o">=</span> <span class="n">normalize_controller_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">CONTROLLER_REGISTRY_LOCK</span><span class="p">:</span>
            <span class="n">CONTROLLER_REGISTRY</span><span class="p">[</span><span class="n">normalized_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered controller &#39;</span><span class="si">{</span><span class="n">normalized_name</span><span class="si">}</span><span class="s2">&#39; -&gt; </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<span class="c1"># ---------- Helper Functions ----------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_as_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Robustly convert an arbitrary object into a plain dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;dict&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_default_gains</span><span class="p">(</span><span class="n">controller_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">gains_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get gains from override, defaults, or raise error.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gains_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">gains_override</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">defaults_all</span> <span class="o">=</span> <span class="n">_as_dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;controller_defaults&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">defaults_all</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">controller_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;gains&quot;</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;gains&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">gains</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">.gains: No gains provided and no defaults found. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Please specify &#39;controller_defaults.</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">.gains&#39; in config or pass gains explicitly.&quot;</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_dynamics_available</span><span class="p">(</span><span class="n">use_full</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure required dynamics model is available.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_full</span> <span class="ow">and</span> <span class="n">FullDIPDynamics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;FullDIPDynamics is unavailable. Ensure &#39;src/core/dynamics_full.py&#39; is importable.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">use_full</span><span class="p">)</span> <span class="ow">and</span> <span class="n">DoubleInvertedPendulum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;DoubleInvertedPendulum is unavailable. Ensure &#39;src/core/dynamics.py&#39; is importable.&quot;</span>
        <span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_validate_shared_params</span><span class="p">(</span><span class="n">controller_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_force</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate common parameters shared by controllers.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span> <span class="ow">and</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">.dt must be &gt; 0 (got </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">max_force</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Real</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max_force</span><span class="p">))</span> <span class="ow">and</span> <span class="n">max_force</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">.max_force must be finite and &gt; 0 (got </span><span class="si">{</span><span class="n">max_force</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># ---------- Main Factory Functions ----------</span>
<div class="viewcode-block" id="build_controller">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.build_controller">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_controller</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># For backward compat with create_controller</span>
    <span class="n">gains</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a single controller from configuration.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Controller name (will be normalized and aliased).</span>
<span class="sd">    cfg : dict or Mapping or ControllerConfig</span>
<span class="sd">        Controller-specific configuration.</span>
<span class="sd">    allow_unknown : bool</span>
<span class="sd">        If True, unknown parameters are stored as unknown_params on the instance.</span>
<span class="sd">        If False, unknown parameters raise FactoryConfigurationError.</span>
<span class="sd">    config : optional</span>
<span class="sd">        Full configuration object (for backward compatibility).</span>
<span class="sd">    gains : optional</span>
<span class="sd">        Explicit gains override.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Controller instance</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FactoryConfigurationError</span>
<span class="sd">        If controller name is unknown or configuration is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize controller name</span>
    <span class="n">controller_name</span> <span class="o">=</span> <span class="n">normalize_controller_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="c1"># Check registry first</span>
    <span class="k">with</span> <span class="n">CONTROLLER_REGISTRY_LOCK</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">controller_name</span> <span class="ow">in</span> <span class="n">CONTROLLER_REGISTRY</span><span class="p">:</span>
            <span class="n">controller_class</span> <span class="o">=</span> <span class="n">CONTROLLER_REGISTRY</span><span class="p">[</span><span class="n">controller_name</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building controller &#39;</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">&#39; from registry&quot;</span><span class="p">)</span>
            
            <span class="c1"># Convert config to dict</span>
            <span class="n">cfg_dict</span> <span class="o">=</span> <span class="n">_as_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            
            <span class="c1"># Apply normalization and deprecation</span>
            <span class="n">normalized_cfg</span> <span class="o">=</span> <span class="n">apply_deprecation_mapping</span><span class="p">(</span><span class="n">controller_name</span><span class="p">,</span> <span class="n">cfg_dict</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span>
            
            <span class="c1"># Handle gains</span>
            <span class="k">if</span> <span class="n">gains</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">normalized_cfg</span><span class="p">[</span><span class="s2">&quot;gains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gains</span>
            <span class="k">elif</span> <span class="s2">&quot;gains&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">normalized_cfg</span> <span class="ow">and</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">normalized_cfg</span><span class="p">[</span><span class="s2">&quot;gains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_default_gains</span><span class="p">(</span><span class="n">controller_name</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># Let the controller handle missing gains</span>
            
            <span class="c1"># Try from_config method first, then constructor</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">controller_class</span><span class="p">,</span> <span class="s2">&quot;from_config&quot;</span><span class="p">):</span>
                    <span class="c1"># If permissive, pass through as-is; from_config should decide.</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="n">controller_class</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">normalized_cfg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># In permissive mode, filter kwargs by the constructor signature.</span>
                    <span class="k">if</span> <span class="n">allow_unknown</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">controller_class</span><span class="p">)</span>
                        <span class="n">valid</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span><span class="p">)}</span>
                        <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">normalized_cfg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">}</span>
                        <span class="n">unknown</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">normalized_cfg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">}</span>
                        <span class="n">instance</span> <span class="o">=</span> <span class="n">controller_class</span><span class="p">(</span><span class="o">**</span><span class="n">filtered</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">unknown</span><span class="p">:</span>
                            <span class="n">instance</span><span class="o">.</span><span class="n">unknown_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;unknown_params&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="o">**</span><span class="n">unknown</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">instance</span> <span class="o">=</span> <span class="n">controller_class</span><span class="p">(</span><span class="o">**</span><span class="n">normalized_cfg</span><span class="p">)</span>
                
                <span class="c1"># Store unknown params if in permissive mode</span>
                <span class="k">if</span> <span class="n">allow_unknown</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;unknown_params&quot;</span><span class="p">):</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">unknown_params</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">unknown_params</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully built controller &#39;</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">instance</span>
                
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Wrap with dot-path</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;unexpected keyword argument&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;(\w+)&#39;&quot;</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">unknown_key</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">unknown_key</span><span class="si">}</span><span class="s2">: Unknown parameter. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">: Failed to construct. Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
    
    <span class="c1"># Fall back to legacy create_controller for backward compatibility</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controller &#39;</span><span class="si">{</span><span class="n">controller_name</span><span class="si">}</span><span class="s2">&#39; not in registry, trying legacy construction&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_legacy_create_controller</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span></div>


<div class="viewcode-block" id="build_all">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.build_all">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_all</span><span class="p">(</span>
    <span class="n">controllers_cfg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build all controllers from a ControllersConfig.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    controllers_cfg : ControllersConfig or dict</span>
<span class="sd">        Configuration for all controllers.</span>
<span class="sd">    allow_unknown : bool</span>
<span class="sd">        If True, unknown parameters are stored on instances.</span>
<span class="sd">        If False, unknown parameters raise errors.</span>
<span class="sd">    config : optional</span>
<span class="sd">        Full configuration object for defaults.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[str, Controller]</span>
<span class="sd">        Mapping of controller names to instances.</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FactoryConfigurationError</span>
<span class="sd">        If any controller fails to build (aggregates all errors).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">built_controllers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Handle different config types</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">controllers_cfg</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">controllers_cfg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">controllers_cfg</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">controllers_cfg</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">controllers_cfg</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">_as_dict</span><span class="p">(</span><span class="n">controllers_cfg</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">controller_cfg</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">controller</span> <span class="o">=</span> <span class="n">build_controller</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> 
                <span class="n">controller_cfg</span><span class="p">,</span> 
                <span class="n">allow_unknown</span><span class="o">=</span><span class="n">allow_unknown</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span>
            <span class="p">)</span>
            <span class="n">built_controllers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
            <span class="s2">&quot;Failed to build controllers:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully built </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">built_controllers</span><span class="p">)</span><span class="si">}</span><span class="s2"> controllers: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">built_controllers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">built_controllers</span></div>


<span class="c1"># ---------- Legacy Support ----------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_legacy_create_controller</span><span class="p">(</span>
    <span class="n">ctrl_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ctrl_cfg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">gains</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Legacy controller creation for backward compatibility.&quot;&quot;&quot;</span>
    <span class="c1"># Load config if needed</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">load_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No configuration loader available. Provide &#39;config&#39; explicitly.&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>
    
    <span class="c1"># Handle global seed if present</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;global_seed&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">global_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_global_seed</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set global seed to </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">global_seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not set global seed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">key</span> <span class="o">=</span> <span class="n">normalize_controller_name</span><span class="p">(</span><span class="n">ctrl_name</span><span class="p">)</span>
    
    <span class="c1"># Get controllers from config</span>
    <span class="n">controllers_map</span> <span class="o">=</span> <span class="n">_as_dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;controllers&quot;</span><span class="p">,</span> <span class="p">{}))</span>
    
    <span class="c1"># Legacy classical_smc aliasing</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">controllers_map</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;classical_smc&quot;</span> <span class="ow">and</span> <span class="s2">&quot;classic_smc&quot;</span> <span class="ow">in</span> <span class="n">controllers_map</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;classic_smc&quot;</span>
    
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">controllers_map</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="s2">&quot;none configured&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">controllers_map</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">controllers_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Controller &#39;</span><span class="si">{</span><span class="n">ctrl_name</span><span class="si">}</span><span class="s2">&#39; not found in config.controllers. Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># Get dynamics model preference</span>
    <span class="n">use_full</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sim_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sim_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_full</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sim_cfg</span><span class="p">,</span> <span class="s2">&quot;use_full_dynamics&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">use_full</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">_ensure_dynamics_available</span><span class="p">(</span><span class="n">use_full</span><span class="p">)</span>
    
    <span class="c1"># Get controller config and merge with overrides</span>
    <span class="n">ctrl_cfg_obj</span> <span class="o">=</span> <span class="n">controllers_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">ctrl_cfg_dict</span> <span class="o">=</span> <span class="n">_as_dict</span><span class="p">(</span><span class="n">ctrl_cfg_obj</span><span class="p">)</span>
    
    <span class="c1"># Merge any provided cfg</span>
    <span class="k">if</span> <span class="n">ctrl_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">override_dict</span> <span class="o">=</span> <span class="n">_as_dict</span><span class="p">(</span><span class="n">ctrl_cfg</span><span class="p">)</span>
        <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">override_dict</span><span class="p">)</span>
    
    <span class="c1"># Apply normalization and deprecation</span>
    <span class="n">ctrl_cfg_dict</span> <span class="o">=</span> <span class="n">apply_deprecation_mapping</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span>
    
    <span class="c1"># Build dynamics model</span>
    <span class="n">dynamics_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">phys</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;physics&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_full</span><span class="p">:</span>
                <span class="n">dynamics_model</span> <span class="o">=</span> <span class="n">FullDIPDynamics</span><span class="p">(</span><span class="n">phys</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dynamics_model</span> <span class="o">=</span> <span class="n">DoubleInvertedPendulum</span><span class="p">(</span><span class="n">phys</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">dynamics_model</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Get shared parameters</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sim_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">sim_dt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sim_cfg</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">sim_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">sim_dt</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">dt_in_cfg</span> <span class="o">=</span> <span class="s2">&quot;dt&quot;</span> <span class="ow">in</span> <span class="n">ctrl_cfg_dict</span>
    <span class="n">mf_in_cfg</span> <span class="o">=</span> <span class="s2">&quot;max_force&quot;</span> <span class="ow">in</span> <span class="n">ctrl_cfg_dict</span>
    
    <span class="k">if</span> <span class="n">dt_in_cfg</span><span class="p">:</span>
        <span class="n">shared_dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shared_dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim_dt</span> <span class="k">if</span> <span class="n">sim_dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: no &#39;dt&#39; specified; inheriting dt=</span><span class="si">{</span><span class="n">shared_dt</span><span class="si">}</span><span class="s2"> from simulation configuration.&quot;</span>
        <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">mf_in_cfg</span><span class="p">:</span>
        <span class="n">shared_max_force</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_force&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shared_max_force</span> <span class="o">=</span> <span class="mf">20.0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: no &#39;max_force&#39; specified; using default max_force=</span><span class="si">{</span><span class="n">shared_max_force</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    
    <span class="n">_validate_shared_params</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">)</span>
    
    <span class="c1"># Delegate to specific controller construction</span>
    <span class="c1"># This is the legacy if/elif chain from the original factory</span>
    <span class="c1"># We keep it for backward compatibility</span>
    
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;classical_smc&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_build_classical_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;sta_smc&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_build_sta_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;adaptive_smc&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_build_adaptive_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;swing_up_smc&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_build_swing_up_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;hybrid_adaptive_sta_smc&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_build_hybrid_adaptive_sta_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;mpc_controller&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_build_mpc_controller</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controller &#39;</span><span class="si">{</span><span class="n">ctrl_name</span><span class="si">}</span><span class="s2">&#39; is not a recognized type.&quot;</span><span class="p">)</span>

<span class="c1"># Individual controller builders (legacy)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_build_classical_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ClassicalSMC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Controller &#39;classical_smc&#39; is unavailable (import error). Ensure required modules are importable.&quot;</span>
        <span class="p">)</span>
    
    <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;switch_method&quot;</span><span class="p">,</span> <span class="s2">&quot;regularization&quot;</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span>
    <span class="p">}</span>
    <span class="n">unknown_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">allowed</span>
    
    <span class="k">if</span> <span class="n">unknown_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unknown</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: Unknown configuration keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">))</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Allowed keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    
    <span class="n">boundary_layer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">boundary_layer</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.boundary_layer must be &gt; 0 (got </span><span class="si">{</span><span class="n">boundary_layer</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="n">switch_method</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switch_method&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">switch_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">switch_method</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch_method</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">switch_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.switch_method must be one of [&#39;tanh&#39;,&#39;linear&#39;] (got </span><span class="si">{</span><span class="n">switch_method</span><span class="si">!r}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
    
    <span class="n">regularization</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;regularization&quot;</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">))</span>
    <span class="n">gains_to_use</span> <span class="o">=</span> <span class="n">_get_default_gains</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">)</span>
    
    <span class="n">instance</span> <span class="o">=</span> <span class="n">ClassicalSMC</span><span class="p">(</span>
        <span class="n">gains</span><span class="o">=</span><span class="n">gains_to_use</span><span class="p">,</span>
        <span class="n">dynamics_model</span><span class="o">=</span><span class="n">dynamics_model</span><span class="p">,</span>
        <span class="n">max_force</span><span class="o">=</span><span class="n">shared_max_force</span><span class="p">,</span>
        <span class="n">boundary_layer</span><span class="o">=</span><span class="n">boundary_layer</span><span class="p">,</span>
        <span class="n">regularization</span><span class="o">=</span><span class="n">regularization</span><span class="p">,</span>
        <span class="o">**</span><span class="p">({</span><span class="s2">&quot;switch_method&quot;</span><span class="p">:</span> <span class="n">switch_method</span><span class="p">}</span> <span class="k">if</span> <span class="n">switch_method</span> <span class="k">else</span> <span class="p">{}),</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">allow_unknown</span> <span class="ow">and</span> <span class="n">unknown_keys</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">unknown_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unknown_keys</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">instance</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_build_sta_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SuperTwistingSMC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Controller &#39;sta_smc&#39; is unavailable (import error). Ensure required modules are importable.&quot;</span>
        <span class="p">)</span>
    
    <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;switch_method&quot;</span><span class="p">,</span> <span class="s2">&quot;regularization&quot;</span><span class="p">,</span> <span class="s2">&quot;anti_windup_gain&quot;</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span>
    <span class="p">}</span>
    <span class="n">unknown_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">allowed</span>
    
    <span class="k">if</span> <span class="n">unknown_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unknown</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: Unknown configuration keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">))</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Allowed keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    
    <span class="n">boundary_layer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">boundary_layer</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.boundary_layer must be &gt; 0 (got </span><span class="si">{</span><span class="n">boundary_layer</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="n">switch_method</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switch_method&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">switch_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">switch_method</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">switch_method</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">switch_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.switch_method must be one of [&#39;tanh&#39;,&#39;linear&#39;] (got </span><span class="si">{</span><span class="n">switch_method</span><span class="si">!r}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
    
    <span class="n">regularization</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;regularization&quot;</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">))</span>
    <span class="n">gains_to_use</span> <span class="o">=</span> <span class="n">_get_default_gains</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">)</span>
    
    <span class="n">instance</span> <span class="o">=</span> <span class="n">SuperTwistingSMC</span><span class="p">(</span>
        <span class="n">gains</span><span class="o">=</span><span class="n">gains_to_use</span><span class="p">,</span>
        <span class="n">dynamics_model</span><span class="o">=</span><span class="n">dynamics_model</span><span class="p">,</span>
        <span class="n">max_force</span><span class="o">=</span><span class="n">shared_max_force</span><span class="p">,</span>
        <span class="n">damping_gain</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">boundary_layer</span><span class="o">=</span><span class="n">boundary_layer</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">shared_dt</span><span class="p">,</span>
        <span class="n">regularization</span><span class="o">=</span><span class="n">regularization</span><span class="p">,</span>
        <span class="o">**</span><span class="p">({</span><span class="s2">&quot;switch_method&quot;</span><span class="p">:</span> <span class="n">switch_method</span><span class="p">}</span> <span class="k">if</span> <span class="n">switch_method</span> <span class="k">else</span> <span class="p">{}),</span>
        <span class="o">**</span><span class="p">({</span><span class="s2">&quot;anti_windup_gain&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="s2">&quot;anti_windup_gain&quot;</span><span class="p">])}</span> <span class="k">if</span> <span class="s2">&quot;anti_windup_gain&quot;</span> <span class="ow">in</span> <span class="n">ctrl_cfg_dict</span> <span class="k">else</span> <span class="p">{}),</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">allow_unknown</span> <span class="ow">and</span> <span class="n">unknown_keys</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">unknown_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unknown_keys</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">instance</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_build_adaptive_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">AdaptiveSMC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Controller &#39;adaptive_smc&#39; is unavailable (import error). Ensure required modules are importable.&quot;</span>
        <span class="p">)</span>
    
    <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="s2">&quot;leak_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;dead_zone&quot;</span><span class="p">,</span> <span class="s2">&quot;adapt_rate_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;K_min&quot;</span><span class="p">,</span> <span class="s2">&quot;K_max&quot;</span><span class="p">,</span> <span class="s2">&quot;smooth_switch&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary_layer&quot;</span><span class="p">,</span> <span class="s2">&quot;K_init&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span>
    <span class="p">}</span>
    <span class="n">unknown_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">allowed</span>
    
    <span class="k">if</span> <span class="n">unknown_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unknown</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: Unknown configuration keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">))</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Allowed keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    
    <span class="n">gains_to_use</span> <span class="o">=</span> <span class="n">_get_default_gains</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">}</span>
    <span class="n">filtered</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">)</span>
    <span class="n">filtered</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;boundary_layer&quot;</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">:</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="p">[</span><span class="s2">&quot;boundary_layer&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bl</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.boundary_layer must be &gt; 0 (got </span><span class="si">{</span><span class="n">bl</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="n">instance</span> <span class="o">=</span> <span class="n">AdaptiveSMC</span><span class="p">(</span><span class="n">gains</span><span class="o">=</span><span class="n">gains_to_use</span><span class="p">,</span> <span class="o">**</span><span class="n">filtered</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">allow_unknown</span> <span class="ow">and</span> <span class="n">unknown_keys</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">unknown_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unknown_keys</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">instance</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_build_swing_up_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">SwingUpSMC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Controller &#39;swing_up_smc&#39; is unavailable (import error). Ensure required modules are importable.&quot;</span>
        <span class="p">)</span>
    
    <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="s2">&quot;stabilizing_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_gain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;switch_energy_factor&quot;</span><span class="p">,</span> <span class="s2">&quot;exit_energy_factor&quot;</span><span class="p">,</span> <span class="s2">&quot;switch_angle_tolerance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reentry_angle_tolerance&quot;</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span>
    <span class="p">}</span>
    <span class="n">unknown_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">allowed</span>
    
    <span class="k">if</span> <span class="n">unknown_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unknown</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: Unknown configuration keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">))</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Allowed keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    
    <span class="n">inner_name</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stabilizing_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;classical_smc&quot;</span><span class="p">)</span>
    <span class="n">normalized_inner</span> <span class="o">=</span> <span class="n">normalize_controller_name</span><span class="p">(</span><span class="n">inner_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalized_inner</span> <span class="o">==</span> <span class="s2">&quot;swing_up_smc&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="s2">&quot;swing_up_smc cannot use itself as stabilizing_controller.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Recursively build stabilizer</span>
    <span class="n">stabilizer</span> <span class="o">=</span> <span class="n">build_controller</span><span class="p">(</span><span class="n">inner_name</span><span class="p">,</span> <span class="p">{},</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="n">max_force</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
        <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stabilizer</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">))</span>
    <span class="p">)</span>
    
    <span class="n">instance</span> <span class="o">=</span> <span class="n">SwingUpSMC</span><span class="p">(</span>
        <span class="n">dynamics_model</span><span class="o">=</span><span class="n">dynamics_model</span><span class="p">,</span>
        <span class="n">stabilizing_controller</span><span class="o">=</span><span class="n">stabilizer</span><span class="p">,</span>
        <span class="n">energy_gain</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;energy_gain&quot;</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">)),</span>
        <span class="n">switch_energy_factor</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switch_energy_factor&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)),</span>
        <span class="n">exit_energy_factor</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exit_energy_factor&quot;</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">)),</span>
        <span class="n">switch_angle_tolerance</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switch_angle_tolerance&quot;</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">)),</span>
        <span class="n">reentry_angle_tolerance</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span>
            <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;reentry_angle_tolerance&quot;</span><span class="p">,</span>
                <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switch_angle_tolerance&quot;</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">shared_dt</span><span class="p">,</span>
        <span class="n">max_force</span><span class="o">=</span><span class="n">max_force</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">allow_unknown</span> <span class="ow">and</span> <span class="n">unknown_keys</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">unknown_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unknown_keys</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">instance</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_build_hybrid_adaptive_sta_smc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">dynamics_model</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">HybridAdaptiveSTASMC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Controller &#39;hybrid_adaptive_sta_smc&#39; is unavailable (import error).&quot;</span>
        <span class="p">)</span>
    
    <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="s2">&quot;k1_init&quot;</span><span class="p">,</span> <span class="s2">&quot;k2_init&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma1&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma2&quot;</span><span class="p">,</span> <span class="s2">&quot;dead_zone&quot;</span><span class="p">,</span>
        <span class="s2">&quot;use_equivalent&quot;</span><span class="p">,</span> <span class="s2">&quot;enable_equivalent&quot;</span><span class="p">,</span> <span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span> <span class="s2">&quot;adapt_rate_limit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sat_soft_width&quot;</span><span class="p">,</span> <span class="s2">&quot;cart_gain&quot;</span><span class="p">,</span> <span class="s2">&quot;cart_lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;cart_p_gain&quot;</span><span class="p">,</span> <span class="s2">&quot;cart_p_lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span>
    <span class="p">}</span>
    <span class="n">unknown_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">allowed</span>
    
    <span class="k">if</span> <span class="n">unknown_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unknown</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: Unknown configuration keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">))</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Allowed keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    
    <span class="n">gains_to_use</span> <span class="o">=</span> <span class="n">_get_default_gains</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">)</span>
    
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed</span>
    <span class="p">}</span>
    <span class="n">filtered</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">)</span>
    <span class="n">filtered</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">)</span>
    
    <span class="c1"># Handle equivalent control flags</span>
    <span class="n">eq_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s2">&quot;enable_equivalent&quot;</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">:</span>
        <span class="n">eq_kwargs</span><span class="p">[</span><span class="s2">&quot;enable_equivalent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;enable_equivalent&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s2">&quot;use_equivalent&quot;</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">:</span>
        <span class="n">eq_kwargs</span><span class="p">[</span><span class="s2">&quot;use_equivalent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_equivalent&quot;</span><span class="p">))</span>
    
    <span class="n">instance</span> <span class="o">=</span> <span class="n">HybridAdaptiveSTASMC</span><span class="p">(</span>
        <span class="n">gains</span><span class="o">=</span><span class="n">gains_to_use</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">)),</span>
        <span class="n">max_force</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">)),</span>
        <span class="n">k1_init</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k1_init&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">k2_init</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;k2_init&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">gamma1</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gamma1&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">gamma2</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gamma2&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">dead_zone</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dead_zone&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">damping_gain</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;damping_gain&quot;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)),</span>
        <span class="n">adapt_rate_limit</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adapt_rate_limit&quot;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)),</span>
        <span class="n">sat_soft_width</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sat_soft_width&quot;</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)),</span>
        <span class="n">cart_gain</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cart_gain&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
        <span class="n">cart_lambda</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cart_lambda&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
        <span class="n">cart_p_gain</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cart_p_gain&quot;</span><span class="p">,</span> <span class="mf">80.0</span><span class="p">)),</span>
        <span class="n">cart_p_lambda</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cart_p_lambda&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)),</span>
        <span class="n">dynamics_model</span><span class="o">=</span><span class="n">dynamics_model</span><span class="p">,</span>
        <span class="o">**</span><span class="n">eq_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">allow_unknown</span> <span class="ow">and</span> <span class="n">unknown_keys</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">unknown_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unknown_keys</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">instance</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_build_mpc_controller</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ctrl_cfg_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">gains</span><span class="p">,</span> <span class="n">shared_dt</span><span class="p">,</span> <span class="n">shared_max_force</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">MPCController</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;Controller &#39;mpc_controller&#39; is unavailable (missing optional dependency).&quot;</span>
        <span class="p">)</span>
    
    <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;max_force&quot;</span><span class="p">,</span> <span class="s2">&quot;horizon&quot;</span><span class="p">,</span> <span class="s2">&quot;q_x&quot;</span><span class="p">,</span> <span class="s2">&quot;q_theta&quot;</span><span class="p">,</span> <span class="s2">&quot;r_u&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_theta_dev&quot;</span><span class="p">,</span> <span class="s2">&quot;max_cart_pos&quot;</span><span class="p">,</span> <span class="s2">&quot;fallback_smc_gains&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallback_pd_kp&quot;</span><span class="p">,</span> <span class="s2">&quot;fallback_pd_kd&quot;</span><span class="p">,</span> <span class="s2">&quot;gains&quot;</span>
    <span class="p">}</span>
    <span class="n">unknown_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">allowed</span>
    
    <span class="k">if</span> <span class="n">unknown_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unknown</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FactoryConfigurationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: Unknown configuration keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown_keys</span><span class="p">))</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Allowed keys: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># Validate MPC params</span>
    <span class="k">if</span> <span class="s2">&quot;horizon&quot;</span> <span class="ow">in</span> <span class="n">ctrl_cfg_dict</span><span class="p">:</span>
        <span class="n">hv</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hv</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.horizon must be an integer  1 (got </span><span class="si">{</span><span class="n">hv</span><span class="si">!r}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">horizon</span> <span class="o">=</span> <span class="n">hv</span>
        <span class="k">if</span> <span class="n">horizon</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.horizon must be  1 (got </span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="n">max_cart_pos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_cart_pos&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">max_cart_pos</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_cart_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.max_cart_pos must be &gt; 0 (got </span><span class="si">{</span><span class="n">max_cart_pos</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;max_theta_dev&quot;</span> <span class="ow">in</span> <span class="n">ctrl_cfg_dict</span><span class="p">:</span>
        <span class="n">mtd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="s2">&quot;max_theta_dev&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mtd</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mtd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.max_theta_dev must be &gt; 0 when provided (got </span><span class="si">{</span><span class="n">mtd</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">wkey</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;q_x&quot;</span><span class="p">,</span> <span class="s2">&quot;q_theta&quot;</span><span class="p">,</span> <span class="s2">&quot;r_u&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wkey</span> <span class="ow">in</span> <span class="n">ctrl_cfg_dict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="n">wkey</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">wkey</span><span class="si">}</span><span class="s2"> must be  0 (got </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Build dummy dynamics</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">_DummyDyn</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">continuous_dynamics</span> <span class="o">=</span> <span class="n">f</span>
    
    <span class="n">prediction_model</span> <span class="o">=</span> <span class="n">_DummyDyn</span><span class="p">()</span>
    
    <span class="c1"># Build weights</span>
    <span class="n">q_x</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q_x&quot;</span><span class="p">)</span>
    <span class="n">q_theta</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;q_theta&quot;</span><span class="p">)</span>
    <span class="n">r_u</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;r_u&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">q_x</span><span class="p">,</span> <span class="n">q_theta</span><span class="p">,</span> <span class="n">r_u</span><span class="p">)):</span>
        <span class="n">weight_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">q_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_kwargs</span><span class="p">[</span><span class="s2">&quot;q_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">q_x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q_theta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_kwargs</span><span class="p">[</span><span class="s2">&quot;q_theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">q_theta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r_u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_kwargs</span><span class="p">[</span><span class="s2">&quot;r_u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r_u</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">MPCWeights</span><span class="p">(</span><span class="o">**</span><span class="n">weight_kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">theta_dev</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_theta_dev&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">mpc_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dynamics_model&quot;</span><span class="p">:</span> <span class="n">prediction_model</span><span class="p">,</span>
        <span class="s2">&quot;horizon&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizon&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)),</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">shared_dt</span><span class="p">),</span>
        <span class="s2">&quot;max_force&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">shared_max_force</span><span class="p">),</span>
        <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
        <span class="s2">&quot;max_cart_pos&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_cart_pos&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">theta_dev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mpc_kwargs</span><span class="p">[</span><span class="s2">&quot;max_theta_dev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">theta_dev</span><span class="p">)</span>
    
    <span class="c1"># Handle fallback gains</span>
    <span class="n">fb_smc</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallback_smc_gains&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fb_smc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mpc_kwargs</span><span class="p">[</span><span class="s2">&quot;fallback_smc_gains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fb_smc</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: fallback_smc_gains must be a sequence of floats; ignoring provided value </span><span class="si">{</span><span class="n">fb_smc</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
    
    <span class="n">fb_kp</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallback_pd_kp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">fb_kd</span> <span class="o">=</span> <span class="n">ctrl_cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallback_pd_kd&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fb_kp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fb_kd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mpc_kwargs</span><span class="p">[</span><span class="s2">&quot;fallback_pd_gains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fb_kp</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">fb_kd</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;controllers.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: fallback_pd_kp/kd must be numeric; using default PD gains.&quot;</span>
            <span class="p">)</span>
    
    <span class="n">instance</span> <span class="o">=</span> <span class="n">MPCController</span><span class="p">(</span><span class="o">**</span><span class="n">mpc_kwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">allow_unknown</span> <span class="ow">and</span> <span class="n">unknown_keys</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">unknown_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">ctrl_cfg_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unknown_keys</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">instance</span>

<span class="c1"># ---------- Backward Compatibility ----------</span>
<span class="c1"># Keep create_controller for backward compatibility</span>
<div class="viewcode-block" id="create_controller">
<a class="viewcode-back" href="../../../api/controllers/factory.html#src.controllers.factory.create_controller">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_controller</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backwards-compatible convenience wrapper used by tests and the CLI.</span>
<span class="sd">    Delegates to build_controller() so mapping/validation stays centralized.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Controller name (aliases allowed).</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        Per-controller constructor args (e.g., gains, dt, max_force).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Unknown *controller names* must still raise.</span>
    <span class="c1"># allow_unknown=True relaxes parameter filtering only.</span>

    <span class="c1"># Normalize controller name</span>
    <span class="n">controller_name</span> <span class="o">=</span> <span class="n">normalize_controller_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Check registry first</span>
    <span class="k">with</span> <span class="n">CONTROLLER_REGISTRY_LOCK</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">controller_name</span> <span class="ow">in</span> <span class="n">CONTROLLER_REGISTRY</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">build_controller</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># For tests and direct usage, try to create directly without config.yaml</span>
    <span class="c1"># Apply deprecation mapping first</span>
    <span class="n">normalized_kwargs</span> <span class="o">=</span> <span class="n">apply_deprecation_mapping</span><span class="p">(</span><span class="n">controller_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Handle direct controller construction for common cases</span>
    <span class="k">if</span> <span class="n">controller_name</span> <span class="o">==</span> <span class="s2">&quot;classical_smc&quot;</span> <span class="ow">and</span> <span class="n">ClassicalSMC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Extract required parameters</span>
        <span class="n">gains</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gains&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controller &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: gains parameter is required&quot;</span><span class="p">)</span>

        <span class="n">max_force</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_force&#39;</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
        <span class="n">boundary_layer</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;boundary_layer&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

        <span class="c1"># Filter known parameters</span>
        <span class="n">known_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;gains&#39;</span><span class="p">:</span> <span class="n">gains</span><span class="p">,</span>
            <span class="s1">&#39;max_force&#39;</span><span class="p">:</span> <span class="n">max_force</span><span class="p">,</span>
            <span class="s1">&#39;boundary_layer&#39;</span><span class="p">:</span> <span class="n">boundary_layer</span><span class="p">,</span>
            <span class="s1">&#39;dynamics_model&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dynamics_model&#39;</span><span class="p">),</span>
            <span class="s1">&#39;regularization&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regularization&#39;</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">),</span>
            <span class="s1">&#39;switch_method&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;switch_method&#39;</span><span class="p">,</span> <span class="s1">&#39;tanh&#39;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Remove None values</span>
        <span class="n">filtered_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">known_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">ClassicalSMC</span><span class="p">(</span><span class="o">**</span><span class="n">filtered_params</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">controller_name</span> <span class="o">==</span> <span class="s2">&quot;sta_smc&quot;</span> <span class="ow">and</span> <span class="n">SuperTwistingSMC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Similar handling for SuperTwistingSMC</span>
        <span class="n">gains</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gains&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controller &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: gains parameter is required&quot;</span><span class="p">)</span>

        <span class="n">max_force</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_force&#39;</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
        <span class="n">boundary_layer</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;boundary_layer&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

        <span class="n">known_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;gains&#39;</span><span class="p">:</span> <span class="n">gains</span><span class="p">,</span>
            <span class="s1">&#39;max_force&#39;</span><span class="p">:</span> <span class="n">max_force</span><span class="p">,</span>
            <span class="s1">&#39;boundary_layer&#39;</span><span class="p">:</span> <span class="n">boundary_layer</span><span class="p">,</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
            <span class="s1">&#39;dynamics_model&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dynamics_model&#39;</span><span class="p">),</span>
            <span class="s1">&#39;damping_gain&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;damping_gain&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;regularization&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regularization&#39;</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">),</span>
            <span class="s1">&#39;switch_method&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;switch_method&#39;</span><span class="p">,</span> <span class="s1">&#39;tanh&#39;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Handle optional anti_windup_gain</span>
        <span class="k">if</span> <span class="s1">&#39;anti_windup_gain&#39;</span> <span class="ow">in</span> <span class="n">normalized_kwargs</span><span class="p">:</span>
            <span class="n">known_params</span><span class="p">[</span><span class="s1">&#39;anti_windup_gain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="p">[</span><span class="s1">&#39;anti_windup_gain&#39;</span><span class="p">]</span>

        <span class="n">filtered_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">known_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">SuperTwistingSMC</span><span class="p">(</span><span class="o">**</span><span class="n">filtered_params</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">controller_name</span> <span class="o">==</span> <span class="s2">&quot;adaptive_smc&quot;</span> <span class="ow">and</span> <span class="n">AdaptiveSMC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Similar handling for AdaptiveSMC with required defaults</span>
        <span class="n">gains</span> <span class="o">=</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gains&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controller &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: gains parameter is required&quot;</span><span class="p">)</span>

        <span class="n">known_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;gains&#39;</span><span class="p">:</span> <span class="n">gains</span><span class="p">,</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
            <span class="s1">&#39;max_force&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_force&#39;</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">),</span>
            <span class="s1">&#39;leak_rate&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leak_rate&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="s1">&#39;dead_zone&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dead_zone&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
            <span class="s1">&#39;adapt_rate_limit&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adapt_rate_limit&#39;</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>
            <span class="s1">&#39;K_min&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;K_min&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="s1">&#39;K_max&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;K_max&#39;</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>
            <span class="s1">&#39;smooth_switch&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smooth_switch&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;boundary_layer&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;boundary_layer&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
            <span class="s1">&#39;K_init&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;K_init&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">normalized_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># All parameters have defaults, so just pass them all</span>
        <span class="k">return</span> <span class="n">AdaptiveSMC</span><span class="p">(</span><span class="o">**</span><span class="n">known_params</span><span class="p">)</span>

    <span class="c1"># For unknown controller names or when direct construction fails,</span>
    <span class="c1"># fall back to full build_controller with config loading</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">gains</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;gains&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">build_controller</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">gains</span><span class="o">=</span><span class="n">gains</span><span class="p">,</span>
            <span class="n">allow_unknown</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># If all else fails, raise error for unknown controller</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Controller &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is not a recognized type&quot;</span><span class="p">)</span></div>


<span class="c1"># Expose the canonical name helper for backward compat</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_canonical</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Legacy/compat alias for tests. Mirrors normalize_controller_name().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">normalize_controller_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">DIP_SMC_PSO Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">src.controllers.factory</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Research Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>